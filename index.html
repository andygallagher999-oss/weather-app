<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üå¶Ô∏è Real Weather Radar App</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body,html{height:100%;font-family:'Segoe UI',Tahoma,sans-serif;}
body{background:#e0eafc;display:flex;flex-direction:column;}
#appContainer{display:flex;flex:1;overflow:hidden;}
#sidebar{width:320px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);display:flex;flex-direction:column;transition:transform .3s ease;overflow:hidden;}
#sidebar.collapsed{transform:translateX(-100%);}
#sidebarHeader{padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;text-align:center;}
#sidebarHeader h1{font-size:20px;margin-bottom:5px;}
#controls{padding:15px;flex:1;overflow-y:auto;}
.control-group{margin-bottom:20px;position:relative;}
.control-group label{display:block;margin-bottom:5px;font-weight:600;}
.location-input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;}
#locationSuggestions{position:absolute;background:white;border:1px solid #ddd;width:calc(100% - 30px);max-height:150px;overflow-y:auto;border-radius:6px;top:58px;z-index:1002;}
#locationSuggestions div{padding:8px;cursor:pointer;border-bottom:1px solid #eee;}
#locationSuggestions div:last-child{border-bottom:none;}
#locationSuggestions div:hover{background:#f0f0f0;}
.btn{width:100%;padding:10px;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px;}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;}
.locations-list{max-height:200px;overflow-y:auto;margin-top:10px;border-radius:8px;border:1px solid #ddd;}
.location-item{padding:8px 10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;}
.location-item:last-child{border-bottom:none;}
.remove-btn{color:#dc3545;font-weight:bold;cursor:pointer;}
#weatherInfo{margin-top:15px;padding:10px;background:white;border-radius:8px;border:1px solid #ddd;font-size:14px;}
#map{flex:1;position:relative;}
.radar-controls{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;z-index:1000;}
.radar-btn{margin:5px 0;padding:8px 12px;border:none;border-radius:6px;font-weight:600;cursor:pointer;color:white;}
.radar-precipitation{background:#28a745;}
.radar-temperature{background:#fd7e14;}
.radar-clouds{background:#6f42c1;}
#radarLegend{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,0.9);padding:10px;border-radius:6px;z-index:1000;font-size:12px;}
#toggleSidebar{display:none;}
@media(max-width:768px){
  #sidebar{position:absolute;z-index:1001;height:100vh;left:0;top:0;}
  #toggleSidebar{display:block;position:absolute;top:10px;left:10px;z-index:1100;background:#fff;border-radius:50%;padding:8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
  #map{height:100vh;}
}
</style>
</head>
<body>
<div id="toggleSidebar">‚ò∞</div>
<div id="appContainer">
  <div id="sidebar">
    <div id="sidebarHeader">
      <h1>üå¶Ô∏è Real Weather Radar</h1>
      <p>Live Weather & Radar</p>
    </div>
    <div id="controls">
      <div class="control-group">
        <label>Add Location</label>
        <input type="text" id="locationInput" class="location-input" placeholder="Enter city name..." />
        <div id="locationSuggestions"></div>
        <button class="btn btn-primary" id="addLocationBtn">Add Location</button>
      </div>
      <div class="control-group">
        <label>Your Locations</label>
        <div class="locations-list" id="locationsList">
          <div class="loading">Loading locations...</div>
        </div>
      </div>
      <div class="control-group">
        <label>Weather Info</label>
        <div id="weatherInfo">
          <h3>Select a location</h3>
          <p>Click a location to see weather details</p>
        </div>
      </div>
    </div>
  </div>
  <div id="map"></div>
</div>
<div class="radar-controls">
  <button class="radar-btn radar-precipitation" onclick="toggleRadarLayer('precipitation')">üåßÔ∏è Precipitation</button>
  <button class="radar-btn radar-temperature" onclick="toggleRadarLayer('temperature')">üå°Ô∏è Temperature</button>
  <button class="radar-btn radar-clouds" onclick="toggleRadarLayer('clouds')">‚òÅÔ∏è Clouds</button>
</div>
<div id="radarLegend">
  <strong>Radar Legend:</strong><br />
  üåßÔ∏è Precipitation: Light ‚Üí Green ‚Üí Yellow ‚Üí Red<br />
  üå°Ô∏è Temperature: Cold Blue ‚Üí Orange ‚Üí Hot Red<br />
  ‚òÅÔ∏è Clouds: Light Purple ‚Üí Dark Purple
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const API_KEY = '54e9fa50b7c99e471e715c740dc958af';
const API_BASE = 'https://api.openweathermap.org/data/2.5';
const TILE_URL = 'https://tile.openweathermap.org/map';

let map, locations = {}, markers = {}, currentRadarLayer = null;

// ---------- App Init ----------
function initializeApp(){
  map = L.map('map').setView([43.6532,-79.3832], 6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OpenStreetMap &copy; CARTO', subdomains:'abcd', maxZoom:19
  }).addTo(map);
  loadDefaultLocations();
}

// ---------- API helpers ----------
async function geocodeLocation(name){
  try {
    const r = await fetch(`${API_BASE}/geo/1.0/direct?q=${encodeURIComponent(name)}&limit=5&appid=${API_KEY}`);
    if(!r.ok) throw new Error('Geo API error');
    return await r.json();
  } catch(e){ console.error(e); return []; }
}
async function getWeatherData(lat,lon){
  try {
    const r = await fetch(`${API_BASE}/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`);
    if(!r.ok) throw new Error('Weather API error');
    return await r.json();
  } catch(e){ console.error(e); return null; }
}

// ---------- Locations ----------
async function addLocation(selected){
  const input = document.getElementById('locationInput');
  const name = selected || input.value.trim();
  if(!name) return;
  const results = await geocodeLocation(name);
  if(!results.length) return alert('Location not found');
  const loc = results[0];
  const fullName = `${loc.name},${loc.state?loc.state+',':''}${loc.country}`;
  if(locations[fullName]) return;
  const weather = await getWeatherData(loc.lat, loc.lon);
  if(!weather) return;
  locations[fullName] = {coords:[loc.lat,loc.lon], weather};
  localStorage.setItem('savedLocations', JSON.stringify(Object.keys(locations)));
  addMarker(fullName, [loc.lat,loc.lon], weather);
  addSidebarItem(fullName, weather);
  input.value='';
}

function addMarker(name, coords, weather){
  const m = L.marker(coords).addTo(map);
  m.bindPopup(`<h3>${name}</h3><p>${weather.weather[0].description}, ${Math.round(weather.main.temp)}¬∞C</p>`);
  m.on('click', ()=>focusLocation(name));
  markers[name] = m;
}

function addSidebarItem(name, weather){
  const container = document.getElementById('locationsList');
  const div = document.createElement('div');
  div.className='location-item';
  div.innerHTML=`<div>${name}</div><span class="remove-btn">&times;</span>`;
  div.querySelector('.remove-btn').onclick = e => { e.stopPropagation(); removeLocation(name, div); };
  div.onclick = ()=>focusLocation(name);
  container.appendChild(div);
}

function removeLocation(name, el){
  if(markers[name]) map.removeLayer(markers[name]);
  delete markers[name]; delete locations[name];
  el.remove();
  localStorage.setItem('savedLocations', JSON.stringify(Object.keys(locations)));
}

function focusLocation(name){
  if(!locations[name]) return;
  map.setView(locations[name].coords, 10);
  markers[name].openPopup();
  updateWeatherInfo(name, locations[name].weather);
}

function updateWeatherInfo(name, w){
  document.getElementById('weatherInfo').innerHTML =
    `<h3>${name}</h3>
     <p>Temp: ${Math.round(w.main.temp)}¬∞C (Feels like ${Math.round(w.main.feels_like)}¬∞C)</p>
     <p>Conditions: ${w.weather[0].description}</p>
     <p>Wind: ${w.wind.speed} m/s</p>
     <p>Humidity: ${w.main.humidity}%</p>
     <p>Pressure: ${w.main.pressure} hPa</p>`;
}

async function loadDefaultLocations(){
  const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
  const defaultCities = ['Toronto,CA']; // reliable default
  const cities = [...new Set([...defaultCities, ...saved])];
  document.getElementById('locationsList').innerHTML = '';
  for(const c of cities) await addLocation(c);
}

// ---------- Radar ----------
function toggleRadarLayer(type){
  if(currentRadarLayer) map.removeLayer(currentRadarLayer);
  const codes = {precipitation:'precipitation_new', temperature:'temp_new', clouds:'clouds_new'};
  const op = {precipitation:0.6, temperature:0.5, clouds:0.5};
  const url = `${TILE_URL}/${codes[type]}/{z}/{x}/{y}.png?appid=${API_KEY}`;
  currentRadarLayer = L.tileLayer(url, {opacity: op[type], attribution:'Weather ¬© OpenWeatherMap'}).addTo(map);
}

// ---------- Autocomplete ----------
const sugg = document.getElementById('locationSuggestions');
document.getElementById('locationInput').addEventListener('input', async e=>{
  const q = e.target.value.trim();
  sugg.innerHTML='';
  if(!q) return;
  const res = await geocodeLocation(q);
  res.forEach(r=>{
    const d = document.createElement('div');
    d.textContent = `${r.name},${r.state?r.state+',':''}${r.country}`;
    d.onclick = ()=>{ addLocation(d.textContent); sugg.innerHTML=''; };
    sugg.appendChild(d);
  });
});
document.addEventListener('click', e=>{ if(!e.target.closest('.control-group')) sugg.innerHTML=''; });

document.getElementById('addLocationBtn').onclick = ()=>addLocation();
document.getElementById('toggleSidebar').onclick = ()=>document.getElementById('sidebar').classList.toggle('collapsed');

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
