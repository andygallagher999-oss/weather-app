<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Weather Radar App</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:sans-serif; }
  .app-container { display:flex; flex-direction:column; height:100vh; }
  .sidebar { background:rgba(255,255,255,0.95); padding:10px; max-height:45%; overflow-y:auto; }
  .map-container { flex-grow:1; position:relative; }
  #map { width:100%; height:100%; }
  .control-group { margin-bottom:10px; }
  .location-input { width:calc(100% - 90px); padding:5px; font-size:14px; }
  .btn { padding:5px 10px; margin-left:5px; cursor:pointer; }
  .locations-list { max-height:150px; overflow-y:auto; margin-top:5px; }
  .location-item { padding:5px; cursor:pointer; display:flex; justify-content:space-between; border-bottom:1px solid #ddd; }
  .location-item:hover { background:#f0f0f0; }
  .legend { position:absolute; bottom:10px; left:10px; background:white; padding:8px; border-radius:6px; font-size:12px; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  .status-bar { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.9); padding:6px 10px; border-radius:6px; font-size:12px; }
  @media(max-width:768px){ .app-container{flex-direction:column;} .sidebar{max-height:40%;} }
</style>
</head>
<body>
<div class="app-container">
  <div class="sidebar">
    <div class="control-group">
      <label>Add Location</label>
      <input type="text" id="locationInput" class="location-input" placeholder="Enter city name...">
      <button class="btn" id="addLocationBtn">Add</button>
      <div class="locations-list" id="locationsList"></div>
    </div>
    <div class="control-group">
      <label>Radar Layers</label><br>
      <button class="btn" onclick="toggleRadar('precipitation')">üåßÔ∏è Precipitation</button>
      <button class="btn" onclick="toggleRadar('temperature')">üå°Ô∏è Temperature</button>
      <button class="btn" onclick="toggleRadar('clouds')">‚òÅÔ∏è Clouds</button>
    </div>
  </div>
  <div class="map-container">
    <div id="map"></div>
    <div class="legend" id="legend">Legend</div>
    <div class="status-bar" id="statusBar">Initializing weather data...</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_KEY='54e9fa50b7c99e471e715c740dc958af';
let map, currentRadar=null;
let locations={};
let markers={};

// Initialize map
map = L.map('map').setView([43.6532,-79.3832], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
  subdomains:'abcd', maxZoom:19
}).addTo(map);

// Load locations from localStorage
if(localStorage.getItem('weatherLocations')){
  locations=JSON.parse(localStorage.getItem('weatherLocations'));
  for(const name in locations){
    addMarker(name,locations[name]);
    addSidebarItem(name,locations[name]);
  }
}else{
  // Default location
  const toronto={lat:43.6532,lon:-79.3832};
  locations['Toronto']=toronto;
  localStorage.setItem('weatherLocations',JSON.stringify(locations));
  addMarker('Toronto',toronto);
  addSidebarItem('Toronto',toronto);
}

// Status bar
function updateStatus(msg){ 
  const now=new Date(); 
  document.getElementById('statusBar').textContent=`Last Updated: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} ‚Ä¢ ${msg}`;
}

// Add marker function
function addMarker(name,coords){
  const marker=L.marker([coords.lat,coords.lon]).addTo(map);
  marker.bindPopup(`<b>${name}</b>`).openPopup();
  marker.on('click',()=>focusLocation(name));
  markers[name]=marker;
}

// Add to sidebar
function addSidebarItem(name,coords){
  const list=document.getElementById('locationsList');
  const div=document.createElement('div');
  div.className='location-item';
  div.innerHTML=`<span>${name}</span><span style="cursor:pointer;">&times;</span>`;
  div.onclick=()=>focusLocation(name);
  div.querySelector('span:nth-child(2)').onclick=(e)=>{
    e.stopPropagation();
    removeLocation(name);
  }
  list.appendChild(div);
}

// Focus location
function focusLocation(name){
  const coords=locations[name];
  map.setView([coords.lat,coords.lon],10);
  if(markers[name]) markers[name].openPopup();
  updateStatus(`Focused on ${name}`);
}

// Remove location
function removeLocation(name){
  map.removeLayer(markers[name]);
  delete markers[name];
  delete locations[name];
  localStorage.setItem('weatherLocations',JSON.stringify(locations));
  document.getElementById('locationsList').innerHTML='';
  for(const n in locations) addSidebarItem(n,locations[n]);
  updateStatus(`${name} removed`);
}

// Add location button
document.getElementById('addLocationBtn').onclick=async ()=>{
  const input=document.getElementById('locationInput');
  const q=input.value.trim();
  if(!q) return;
  updateStatus(`Searching for ${q}...`);
  try{
    const res=await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=1&appid=${API_KEY}`);
    const data=await res.json();
    if(data.length===0){ updateStatus(`Location not found: ${q}`); return;}
    const loc={lat:data[0].lat, lon:data[0].lon};
    locations[data[0].name]=loc;
    localStorage.setItem('weatherLocations',JSON.stringify(locations));
    addMarker(data[0].name,loc);
    addSidebarItem(data[0].name,loc);
    updateStatus(`${data[0].name} added`);
    input.value='';
  }catch(err){ updateStatus(`Error adding location`); console.error(err);}
}

// Click map to add location
map.on('click', async (e)=>{
  const {lat,lng}=e.latlng;
  try{
    const res=await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lng}&limit=1&appid=${API_KEY}`);
    const data=await res.json();
    if(data.length===0) return;
    const name=data[0].name;
    if(locations[name]) return;
    const loc={lat,lon:lng};
    locations[name]=loc;
    localStorage.setItem('weatherLocations',JSON.stringify(locations));
    addMarker(name,loc);
    addSidebarItem(name,loc);
    updateStatus(`${name} added by map click`);
  }catch(err){ console.error(err);}
});

// Radar layers
function toggleRadar(type){
  if(currentRadar) map.removeLayer(currentRadar);
  const urls={
    precipitation:`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`,
    temperature:`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${API_KEY}`,
    clouds:`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEY}`
  };
  let opacity=type==='precipitation'?0.6:0.8;
  currentRadar=L.tileLayer(urls[type],{opacity:opacity}).addTo(map);
  updateLegend(type);
  updateStatus(`${type} radar activated`);
}

// Legend
function updateLegend(type){
  const legend=document.getElementById('legend');
  if(type==='precipitation') legend.innerHTML=`<b>Precipitation (mm)</b><br>Blue=light, Dark Blue=heavy`;
  else if(type==='temperature') legend.innerHTML=`<b>Temperature (¬∞C)</b><br>Yellow=hot, Blue=cold`;
  else if(type==='clouds') legend.innerHTML=`<b>Cloud Cover</b><br>Light=low, Dark=high`;
}
</script>
</body>
</html>
