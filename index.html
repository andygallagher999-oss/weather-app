<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Weather Radar App</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
/* ====================
   BASIC RESET & BODY
==================== */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#1e3c72; height:100vh; overflow:hidden; }

/* ====================
   APP CONTAINER
==================== */
#app-container { width:100%; height:100%; position:relative; }
#map { width:100%; height:100%; }

/* ====================
   SIDEBAR PANEL
==================== */
#sidebar {
  position:absolute;
  top:0; right:0;
  width:300px;
  max-width:80%;
  height:100%;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  box-shadow: -2px 0 10px rgba(0,0,0,0.2);
  display:flex;
  flex-direction:column;
  transition: transform 0.3s ease-in-out;
  transform: translateX(0);
  z-index:1001;
}
#sidebar.collapsed { transform: translateX(100%); }

/* HEADER */
#sidebar-header { padding:15px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; text-align:center; }
#sidebar-header h1 { font-size:20px; margin-bottom:5px; }
#sidebar-header p { font-size:12px; opacity:0.9; }

/* CONTROLS */
#controls { padding:15px; flex-grow:1; overflow-y:auto; }
.control-group { margin-bottom:15px; }
.control-group label { font-weight:600; margin-bottom:5px; display:block; font-size:13px; color:#333; }
.location-input { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
.location-suggestions { background:white; border:1px solid #ccc; max-height:150px; overflow-y:auto; position:absolute; width:calc(100% - 32px); z-index:1002; display:none; }
.location-suggestions div { padding:8px; cursor:pointer; }
.location-suggestions div:hover { background:#f0f0f0; }
.btn { width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin-top:5px; }
.btn-primary { background:linear-gradient(135deg,#667eea,#764ba2); color:white; }
.btn-primary:hover { opacity:0.9; }

/* LOCATIONS LIST */
#locationsList { max-height:200px; overflow-y:auto; margin-top:10px; }
.location-item { padding:8px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eaeaea; cursor:pointer; }
.location-item:hover { background:#f0f0f0; }
.remove-btn { color:#dc3545; cursor:pointer; font-weight:bold; }

/* WEATHER INFO */
#weatherInfo { background:white; padding:10px; border-radius:6px; margin-top:10px; font-size:13px; }

/* ====================
   FLOATING ELEMENTS
==================== */
#legend { position:absolute; top:10px; left:10px; background:white; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-size:12px; z-index:1001; }
#radarControls { position:absolute; top:10px; right:10px; background:white; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:flex; flex-direction:column; z-index:1001; }
.radar-btn { margin:3px 0; padding:6px; border:none; border-radius:4px; cursor:pointer; font-weight:600; color:white; }
.radar-precipitation { background:#007bff; }
.radar-temperature { background:#fd7e14; }
.radar-clouds { background:#6f42c1; }

/* ====================
   MOBILE ADJUSTMENTS
==================== */
@media(max-width:768px){
  #sidebar { width:90%; transform: translateY(100%); bottom:0; top:auto; right:5%; height:60%; border-radius:10px 10px 0 0; }
  #sidebar.collapsed { transform: translateY(100%); }
  #sidebar-header { cursor:pointer; }
  #legend, #radarControls { font-size:11px; }
}
</style>
</head>
<body>
<div id="app-container">
  <div id="map"></div>

  <!-- Floating Legend -->
  <div id="legend">
    <h4>Legend</h4>
    <div><span style="background:#87CEEB;width:15px;height:10px;display:inline-block;margin-right:5px;"></span>Clear/Light Clouds</div>
    <div><span style="background:#4169E1;width:15px;height:10px;display:inline-block;margin-right:5px;"></span>Moderate Clouds</div>
    <div><span style="background:#0000FF;width:15px;height:10px;display:inline-block;margin-right:5px;"></span>Heavy Clouds/Light Rain</div>
    <div><span style="background:#8A2BE2;width:15px;height:10px;display:inline-block;margin-right:5px;"></span>Heavy Rain</div>
  </div>

  <!-- Floating Radar Controls -->
  <div id="radarControls">
    <button class="radar-btn radar-precipitation" onclick="toggleRadarLayer('precipitation')">üåßÔ∏è Precip</button>
    <button class="radar-btn radar-temperature" onclick="toggleRadarLayer('temperature')">üå°Ô∏è Temp</button>
    <button class="radar-btn radar-clouds" onclick="toggleRadarLayer('clouds')">‚òÅÔ∏è Clouds</button>
  </div>

  <!-- Sidebar Panel -->
  <div id="sidebar" class="collapsed">
    <div id="sidebar-header">
      <h1>üå¶Ô∏è Real Weather Radar</h1>
      <p>Live Weather & Radar</p>
    </div>
    <div id="controls">
      <div class="control-group">
        <label>Add Location</label>
        <input type="text" id="locationInput" class="location-input" placeholder="Enter city name...">
        <div id="locationSuggestions" class="location-suggestions"></div>
        <button class="btn btn-primary" id="addLocationBtn" onclick="addLocation()">Add Location</button>
      </div>

      <div class="control-group">
        <label>Your Locations</label>
        <div id="locationsList"></div>
      </div>

      <div id="weatherInfo">
        <p>Select a location to see weather info</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const API_KEY='54e9fa50b7c99e471e715c740dc958af';
const OPENWEATHER_BASE='https://api.openweathermap.org/data/2.5';
const OPENWEATHER_TILES='https://tile.openweathermap.org/map';
let map, markers={}, currentRadarLayer=null;
let locations = JSON.parse(localStorage.getItem('weatherLocations')||'{}');

// ==================== INITIALIZE MAP ====================
function initializeMap(){
  map=L.map('map').setView([43.6532,-79.3832],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
  loadDefaultLocations();
}

// ==================== AUTOCOMPLETE ====================
let searchTimeout;
const locationInput = document.getElementById('locationInput');
const suggestionsContainer = document.getElementById('locationSuggestions');
locationInput.addEventListener('input',(e)=>{
  const query=e.target.value.trim();
  suggestionsContainer.innerHTML='';
  if(!query) { suggestionsContainer.style.display='none'; return; }
  if(searchTimeout) clearTimeout(searchTimeout);
  searchTimeout=setTimeout(async()=>{
    try{
      const res=await fetch(`${OPENWEATHER_BASE}/geo/1.0/direct?q=${encodeURIComponent(query)}&limit=5&appid=${API_KEY}`);
      const data=await res.json();
      if(data.length){
        suggestionsContainer.innerHTML='';
        data.forEach(loc=>{
          const div=document.createElement('div');
          div.textContent=`${loc.name}${loc.state?', '+loc.state:''}, ${loc.country}`;
          div.onclick=()=>{ locationInput.value=div.textContent; suggestionsContainer.style.display='none'; };
          suggestionsContainer.appendChild(div);
        });
        suggestionsContainer.style.display='block';
      } else { suggestionsContainer.style.display='none'; }
    }catch(err){ suggestionsContainer.style.display='none'; console.error(err);}
  },300);
});

// ==================== ADD LOCATION ====================
async function addLocation(){
  const name=locationInput.value.trim();
  if(!name) return;
  try{
    const geoRes=await fetch(`${OPENWEATHER_BASE}/geo/1.0/direct?q=${encodeURIComponent(name)}&limit=1&appid=${API_KEY}`);
    const geoData=await geoRes.json();
    if(!geoData.length) { alert('Location not found'); return; }
    const loc=geoData[0];
    const fullName=`${loc.name}${loc.state?', '+loc.state:''}, ${loc.country}`;
    const coords=[loc.lat,loc.lon];
    const weatherRes=await fetch(`${OPENWEATHER_BASE}/weather?lat=${loc.lat}&lon=${loc.lon}&appid=${API_KEY}&units=metric`);
    const weatherData=await weatherRes.json();
    locations[fullName]={coords,weather:weatherData};
    localStorage.setItem('weatherLocations',JSON.stringify(locations));
    addMarker(fullName,coords,weatherData);
    addLocationToSidebar(fullName,weatherData);
    locationInput.value='';
  }catch(err){ console.error(err); alert('Error adding location'); }
}

// ==================== MARKERS & SIDEBAR ====================
function addMarker(name,coords,weather){
  if(markers[name]) map.removeLayer(markers[name]);
  const marker=L.marker(coords).addTo(map);
  marker.bindPopup(`<div style="text-align:center;"><h3>${name}</h3><p>${Math.round(weather.main.temp)}¬∞C - ${weather.weather[0].description}</p></div>`);
  marker.on('click',()=>focusLocation(name));
  markers[name]=marker;
}

function addLocationToSidebar(name,weather){
  const list=document.getElementById('locationsList');
  let div=document.createElement('div');
  div.className='location-item';
  div.onclick=()=>focusLocation(name);
  div.innerHTML=`<span>${name} ‚Ä¢ ${Math.round(weather.main.temp)}¬∞C</span>
                 <span class="remove-btn" onclick="event.stopPropagation(); removeLocation('${name}',this)">&times;</span>`;
  list.appendChild(div);
}

function removeLocation(name,el){
  if(markers[name]) map.removeLayer(markers[name]);
  delete locations[name];
  localStorage.setItem('weatherLocations',JSON.stringify(locations));
  el.parentElement.remove();
}

// ==================== FOCUS LOCATION ====================
function focusLocation(name){
  if(!locations[name]) return;
  const {coords,weather}=locations[name];
  map.setView(coords,10);
  if(markers[name]) markers[name].openPopup();
  const info=document.getElementById('weatherInfo');
  info.innerHTML=`
    <strong>${name}</strong><br>
    Temp: ${Math.round(weather.main.temp)}¬∞C (feels like ${Math.round(weather.main.feels_like)}¬∞C)<br>
    Conditions: ${weather.weather[0].description}<br>
    Wind: ${weather.wind.speed} m/s<br>
    Humidity: ${weather.main.humidity}%<br>
    Pressure: ${weather.main.pressure} hPa
  `;
}

// ==================== LOAD DEFAULT LOCATIONS ====================
async function loadDefaultLocations(){
  if(Object.keys(locations).length){
    for(const name in locations){
      addMarker(name,locations[name].coords,locations[name].weather);
      addLocationToSidebar(name,locations[name].weather);
    }
  } else {
    const defaults=[{name:'Toronto, ON',lat:43.6532,lon:-79.3832}];
    for(const loc of defaults){
      const res=await fetch(`${OPENWEATHER_BASE}/weather?lat=${loc.lat}&lon=${loc.lon}&appid=${API_KEY}&units=metric`);
      const weather=await res.json();
      const fullName=loc.name;
      locations[fullName]={coords:[loc.lat,loc.lon],weather};
      localStorage.setItem('weatherLocations',JSON.stringify(locations));
      addMarker(fullName,[loc.lat,loc.lon],weather);
      addLocationToSidebar(fullName,weather);
    }
  }
}

// ==================== RADAR LAYERS ====================
function toggleRadarLayer(type){
  if(currentRadarLayer) map.removeLayer(currentRadarLayer);
  let layerCode;
  if(type==='precipitation') layerCode='precipitation_new';
  else if(type==='temperature') layerCode='temp_new';
  else if(type==='clouds') layerCode='clouds_new';
  else return;
  currentRadarLayer=L.tileLayer(`${OPENWEATHER_TILES}/${layerCode}/{z}/{x}/{y}.png?appid=${API_KEY}`,{opacity:0.6,attribution:'Weather ¬© OpenWeatherMap'});
  map.addLayer(currentRadarLayer);
}

// ==================== SIDEBAR TOGGLE ON MOBILE ====================
document.getElementById('sidebar-header').addEventListener('click',()=>{
  document.getElementById('sidebar').classList.toggle('collapsed');
});

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded',()=>{
  initializeMap();
});
</script>
</body>
</html>
